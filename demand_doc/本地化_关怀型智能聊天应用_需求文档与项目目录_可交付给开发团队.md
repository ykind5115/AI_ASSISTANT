# 项目名称
关怀型本地大模型聊天应用（暂名：CareMate）

---

# 一、项目概述
**背景**：现代人工作与生活节奏快、社交减少，存在长期孤独与情绪困扰的群体。甲方希望构建一款本地运行的智能应用，扮演“知心好友/关怀助手”的角色，通过日常对话与定时主动关怀消息，帮助用户缓解孤独、记录进展并给出鼓励与建议。

**目标用户**：感到孤独、希望有情感支持或需要每日动力/任务反馈的个人用户（强调隐私、所有数据在本地保存）。

**核心目标**：
- 提供自然、温暖、可持续的对话体验，像朋友一样倾听与回应。
- 每天定时发送个性化关怀信息与鼓励，基于用户最近一段时间（可配置）的对话与行为总结。
- 所有数据与模型均可在本地运行与存储，保证隐私。

---

# 二、交付物（高层）
1. 需求文档与项目目录（本文件）。
2. 可运行的本地 Python 应用（含模型推理、后端服务、最简前端/CLI）。
3. 部署说明（包含在开发机器/家庭台式机/笔记本上安装与配置步骤）。
4. 单元测试、集成测试与验收测试用例。
5. 用户手册与运维说明（备份/迁移/卸载）。

---

# 三、功能性需求（详细）
## 3.1 核心功能
### 3.1.1 自然对话（聊天）
- 用户可与应用发起/继续对话（文本为主，后期可选语音）。
- 模型应体现同理心、鼓励性语言、避免给出医疗/法律/诊断意见（见安全约束）。
- 支持会话历史回溯（默认保留最近 30 天对话，配置可修改）。

### 3.1.2 定时关怀推送（Scheduled Care Messages）
- 用户/系统可设置每日/多次定时发送关怀消息（例如：早安、午间小提醒、睡前回顾）。
- 每次推送前，应用会基于“上一时间窗口”（例如：过去 7 天）自动生成一段**摘要 + 鼓励/建议**，并作为推送主体的一部分。
- 推送内容应包含简短总结（用户这段时间的行为/成就）、当日鼓励与可执行建议（1-2 项）。

### 3.1.3 上下文总结与记忆
- 系统能周期性（或按需）对最近对话做抽取式/生成式总结（称为“回顾”），包含：用户情绪走向、目标/待办、近期成就、反复提及的问题。
- 支持“短期记忆”（仅用于生成当次推送/对话）与“长期记忆”（用户明确允许保存的偏好/重要事实）。

### 3.1.4 用户偏好与配置
- 推送频率、时段可配置。
- 允许用户设置语气偏好（如：温柔/中性/鼓励型）、避免话题（敏感词/触发词）、目标（如：减压/学习/运动）。
- 允许用户导出/删除本地数据。

## 3.2 辅助功能
- 系统消息与通知（本地通知或桌面通知）。
- 简单的任务/目标打卡记录（可选）。
- 隐私设置、数据备份/恢复（本地备份到加密文件）。

---

# 四、非功能性需求
- **本地执行**：模型与数据均在用户设备；不依赖外部云服务（除非用户选择手动导入/更新模型）。
- **隐私与安全**：所有对话与摘要保存在本地数据库（默认加密），导出需用户确认。
- **性能**：首次响应延迟在可接受范围内（取决于模型大小，目标：交互式体验 < 5s 在主流消费 GPU 上，CPU 上尽量优化）。
- **可扩展性/可替换性**：模型推理层应易于切换（例如：从小型本地模型切换到更大模型或使用量化的推理引擎）。
- **可测试性**：模块化设计，便于单元测试与集成测试。
- **可维护性**：清晰的代码风格与文档，配置化参数集中管理。

---

# 五、约束与注意事项
- **合规与风险**：应用只做情感支持，**不得提供诊断、医疗建议或法律建议**；若检测到严重自伤/自杀相关内容，应展示本地化的紧急帮助提示（不联网），并建议用户联系专业机构。
- **模型输出控制**：需要对模型 prompt 和生成结果做安全过滤（阻止仇恨、鼓励自伤、暴力等内容）。
- **设备差异**：不同用户硬件能力差异大（无 GPU / 带 GPU / M1/M2 等），需要列出最低与推荐硬件规格并提供降级选项（更小模型或 CPU-only 模式）。

---

# 六、技术选型建议（可替换）
> 注：此处为建议，cursor（技术人员）可根据熟悉的库替换。

- **语言**：Python 3.10+
- **后端服务**：FastAPI（轻量、易部署）或 CLI 工具 + 本地调度器
- **前端**：简单单页（HTML+JS）或 Electron / PyWebView（如果需要桌面统一体验）；或者仅提供 REST API 由第三方 UI 调用
- **模型推理**：Hugging Face Transformers / llama.cpp / ggml 后端 / 其他本地推理引擎（支持量化模型）
- **向量数据库**：SQLite + FAISS（本地索引）或 SQLite + Annoy（轻量），用于短期检索与记忆
- **任务调度**：APScheduler 或内置定时器
- **存储**：SQLite（主），对敏感字段做 AES 加密（本地 key 存储策略需设计）
- **异步**：使用 asyncio + background tasks 提升并发处理能力
- **测试**：pytest

---

# 七、系统架构（模块划分）
1. **接口层（API / UI）**
   - 提供对话接口（POST /chat）
   - 提供推送/订阅管理接口（GET/POST /schedule）
   - 管理用户配置、导出/删除数据接口
2. **服务层（业务逻辑）**
   - 会话管理（会话ID、上下文窗口、记忆读写）
   - 摘要生成器（periodic/triggered）
   - 推送调度器
   - 安全过滤器
3. **模型层**
   - Prompt 管理与模板
   - 本地推理引擎封装（统一接口，支持替换模型）
   - Embedding 服务（供检索/记忆使用）
4. **存储层**
   - 本地 SQLite（会话表、消息表、用户偏好表、摘要表、模型元数据）
   - 本地向量索引（FAISS/Annoy）
5. **运维/辅助**
   - 日志（本地轮转日志）
   - 配置文件（YAML/JSON）

---

# 八、数据模型（建议 Schema）
使用 SQLite，示例表：

- **users**（单机模式下可只有 1 条）
  - id (PK)
  - display_name
  - preferences (JSON)
  - created_at

- **sessions**
  - id (PK)
  - user_id (FK)
  - started_at
  - last_active_at
  - meta (JSON)

- **messages**
  - id (PK)
  - session_id (FK)
  - role (user/system/assistant)
  - content (TEXT)
  - embedding_ref (optional)
  - created_at

- **summaries**
  - id
  - window_start
  - window_end
  - content
  - generated_at

- **schedules**
  - id
  - user_id
  - cron_or_time
  - template_id
  - enabled

- **templates**
  - id
  - name
  - content (prompt template)

---

# 九、API 设计（REST 示例）
- `POST /api/v1/chat` — 请求体：{session_id, message, preferences}；响应：{reply, metadata}
- `GET /api/v1/session/{id}` — 获取会话历史（分页）
- `POST /api/v1/schedule` — 创建/修改定时推送
- `GET /api/v1/summaries?start=&end=` — 获取历史摘要
- `POST /api/v1/export` — 导出用户数据（需用户确认）

---

# 十、Prompt 与生成策略（落地要点）
- 使用明确的 system prompt，明确“我是一个关怀型的助手，只能给予鼓励和支持，不提供医学/法律诊断”。
- 定时摘要 prompt 示例：
  - 输入：过去 7 天的用户消息（抽样） + 最近任务/目标表
  - 输出格式要求：1) 2-3 句行为/成就总结，2) 1-2 条当日可执行建议，3) 1 段温暖的鼓励话语。
- 对生成结果做后处理：长度限制、情绪调控（避免过度负面化）、敏感词过滤。

---

# 十一、测试与验收标准
## 11.1 单元/集成测试
- 覆盖会话管理、摘要生成、调度逻辑、API 接口。

## 11.2 验收测试
- 功能：能够完成一次对话、保存历史、并按配置时间发送包含摘要的推送。
- 隐私：导出/删除数据功能正常工作且导出的文件为加密或明示敏感项。
- 安全：模型在自伤/暴力/仇恨类输入时给出合规应对（回避并给出资源提示）。

---

# 十二、交付与里程碑建议（示例）
- 第 1 周：环境搭建、基础 skeleton（API + SQLite）
- 第 2 周：对话流与本地推理接入（可用最小模型）
- 第 3 周：定时器与摘要生成、基本 prompt 模板
- 第 4 周：配置界面、偏好设置、导出/删除功能
- 第 5 周：安全过滤、测试、性能优化
- 第 6 周：用户验收测试与文档完善

---

# 十三、最低/推荐运行环境
- **最低（CPU-only）**：现代 4 核 CPU、8 GB 内存、20 GB 可用磁盘（适配小型量化模型，响应慢）
- **推荐（良好体验）**：具备 CUDA GPU（NVIDIA RTX 系列 或 等效）、16 GB+ RAM、50 GB 可用磁盘

---

# 十四、开发交付清单（给 cursor 的任务分解）
以下任务以模块化给出，cursor 可据此开始开发：

## A. 初始化
1. 建立项目仓库与基本目录结构（见下面目录样式）。
2. 初始化 Python 环境（virtualenv / poetry），写好 requirements.txt。
3. 建立 CI 本地测试脚本（pytest）。

## B. 存储与会话管理
1. 设计并实现 SQLite schema。
2. 实现会话读写 API 与消息存储接口。

## C. 模型接入
1. 封装统一的模型推理接口（load_model(prompt, config)、generate(...)、embed(...)）。
2. 实现最小可用模型（选择一个小型本地模型或 mock 模型用于开发）。

## D. 摘要与调度
1. 实现摘要生成模块与模板管理。
2. 集成本地调度器，支持 cron-like 配置，能在触发时调用摘要生成并发送消息。

## E. 安全与过滤
1. 实现生成后过滤器与简单触发规则（自伤/暴力/仇恨检测）。
2. 实现导出/删除功能，并在导出前进行用户确认。

## F. 前端/接口
1. 提供最简的 UI（或 Postman/CLI 示例）以便 QA 与验收。
2. 实现桌面通知（不同 OS 适配，至少实现 Windows 和 macOS 的基本方法）。

## G. 文档与发布
1. 编写 README、部署说明、用户手册。
2. 提供可运行的示例（包含一个小 demo 会话流程）。

---

# 十五、项目目录（建议）
```
caremate/                     # 项目根
├─ README.md
├─ LICENSE
├─ pyproject.toml / requirements.txt
├─ .env.example
├─ scripts/
│  ├─ init_db.py
│  ├─ run_local.sh
│  └─ export_data.py
├─ docker/                    # 可选 Docker 支持
│  └─ Dockerfile
├─ app/                       # 应用代码
│  ├─ main.py                  # FastAPI 启动点或 CLI 入口
│  ├─ config.py
│  ├─ api/                     # REST 层
│  │  ├─ v1/
│  │  │  ├─ chat.py
│  │  │  └─ schedule.py
│  ├─ services/                # 业务逻辑
│  │  ├─ session_manager.py
│  │  ├─ scheduler_service.py
│  │  └─ summary_service.py
│  ├─ models/                  # 数据模型/ORM（SQLite）
│  │  └─ schema.py
│  ├─ ml/                      # 模型推理相关
│  │  ├─ model_api.py          # 封装统一接口
│  │  ├─ local_loader.py       # 本地模型加载
│  │  └─ embedding.py
│  ├─ utils/
│  │  ├─ prompts.py
│  │  ├─ security.py           # 过滤与检测
│  │  └─ notifier.py           # 本地通知
│  └─ templates/               # prompt templates
├─ frontend/                   # 可选简易前端
│  ├─ static/
│  └─ index.html
├─ tests/
│  ├─ test_api.py
│  └─ test_summary.py
└─ docs/
   ├─ deploy.md
   └─ user_guide.md
```

---

# 十六、示例对话与推送模板（示例）
**示例对话**：
- 用户：我今天一个人加班到很晚，好累。
- 助手：听起来你今天真的非常辛苦。你完成了很多工作，这值得被肯定。今晚回家后可以先做 10 分钟放松呼吸，然后早点休息。我会在明天早上再来问问你睡得怎么样。

**推送模板（早安）**：
> 早安！过去几天你提到在忙于 X（简短总结）。这是你做得不错的一点：Y（成就）。今天的小建议：尝试在上午安排 30 分钟专注时间来推进 Z。我相信你可以做到，加油！

---

# 十七、交付验收清单（甲方验收要点）
1. 基本对话流程通顺、可存储历史。
2. 定时推送功能按配置触发，且推送包含基于历史的总结与建议。
3. 所有数据可本地导出与删除，数据导出/删除有确认流程。
4. 提供部署与运行说明，能在甲方一台测试机上复现运行。
5. 提供单元/集成测试，覆盖率合理。

---

# 十八、后续功能建议（可选）
- 支持语音输入/输出（离线语音模型）。
- 情绪可视化（简单图表显示用户情绪趋势）。
- 多人家庭模式（多用户家庭共享设备时的隐私隔离）。






